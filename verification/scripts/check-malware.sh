#!/bin/bash
#
# SpeakUp Malware Verification Script
#
# Purpose: Automated scanning of repository files for malware using ClamAV
# Method: ClamAV virus scanner
# Output: Test results logged to verification/Malware-Scan-Results.md
#
# Exit codes:
#   0 = Scan passed (no malware found)
#   1 = Malware detected or scan error
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
OUTPUT_FILE="$REPO_ROOT/verification/Malware-Scan-Results.md"
TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")

# Check for clamscan
CLAMSCAN="/opt/homebrew/bin/clamscan"
if [ ! -x "$CLAMSCAN" ]; then
    CLAMSCAN=$(which clamscan 2>/dev/null || echo "")
fi

if [ -z "$CLAMSCAN" ] || [ ! -x "$CLAMSCAN" ]; then
    echo "ERROR: ClamAV (clamscan) not found"
    echo "Install with: brew install clamav"
    exit 1
fi

# Get ClamAV version
CLAMAV_VERSION=$($CLAMSCAN --version 2>/dev/null | head -1)

echo "SpeakUp Malware Verification Scan"
echo "=================================="
echo "Timestamp: $TIMESTAMP"
echo "Scanner: $CLAMAV_VERSION"
echo ""
echo "Scanning repository: $REPO_ROOT"
echo ""

# Run scan and capture output
SCAN_OUTPUT=$(mktemp)
$CLAMSCAN --recursive --infected --no-summary "$REPO_ROOT" > "$SCAN_OUTPUT" 2>&1 || true

# Count infected files
INFECTED_COUNT=$(grep -c "FOUND$" "$SCAN_OUTPUT" 2>/dev/null || true)
if [ -z "$INFECTED_COUNT" ]; then
    INFECTED_COUNT=0
fi

# Get summary by running with summary
SCAN_SUMMARY=$($CLAMSCAN --recursive "$REPO_ROOT" 2>&1 | tail -10)

# Initialize output file
cat > "$OUTPUT_FILE" << EOF
# Malware Scan Results

---

## Scan Information

| Field | Value |
|-------|-------|
| Scan Date | $TIMESTAMP |
| Script | verification/scripts/check-malware.sh |
| Scanner | $CLAMAV_VERSION |
| Repository | $REPO_ROOT |

---

## Scan Summary

\`\`\`
$SCAN_SUMMARY
\`\`\`

---

## Results

EOF

if [ "$INFECTED_COUNT" -eq 0 ]; then
    echo "**Status: PASS**" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
    echo "No malware or suspicious files detected in the repository." >> "$OUTPUT_FILE"
    echo ""
    echo "=================================="
    echo "RESULT: PASS"
    echo "No malware detected."
    EXIT_CODE=0
else
    echo "**Status: FAIL**" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
    echo "**WARNING: $INFECTED_COUNT infected file(s) detected:**" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
    echo "\`\`\`" >> "$OUTPUT_FILE"
    cat "$SCAN_OUTPUT" >> "$OUTPUT_FILE"
    echo "\`\`\`" >> "$OUTPUT_FILE"
    echo ""
    echo "=================================="
    echo "RESULT: FAIL"
    echo "$INFECTED_COUNT infected file(s) detected!"
    cat "$SCAN_OUTPUT"
    EXIT_CODE=1
fi

rm -f "$SCAN_OUTPUT"

echo "" >> "$OUTPUT_FILE"
echo "---" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"
echo "*This report was automatically generated by the SpeakUp malware verification script using ClamAV.*" >> "$OUTPUT_FILE"

echo ""
echo "Results written to: $OUTPUT_FILE"

exit $EXIT_CODE
